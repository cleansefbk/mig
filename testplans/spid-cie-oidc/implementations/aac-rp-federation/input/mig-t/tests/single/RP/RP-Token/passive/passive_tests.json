{
  "test suite": {
    "description": "Passive tests - RP-Token",
    "filter messages": true,
    "name": "Passive tests - RP-Token"
  },
  "tests": [
    {
      "test": {
        "description": "This test can be performed by taking the JWT present in the 'client_assertion' field of the RP's request, base64url decoding the payload and checking the aud. Its value must be an URL",
        "name": "Does the signed JWT assertion contain a correct aud claim",
        "operations": [
          {
            "decode operations": [
              {
                "checks": [
                  {
                    "check regex": "\"aud\":\\s*\\[\\s*\"(https?:\\/\\/(www\\\\.)?[-\\w@:%.\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-\\w()@:%\\+.~#?&\\/\\/=]*))\"\\s*(,\\s*\"(https?:\\/\\/(www\\.)?[-\\w@:%.\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-\\w()@:%\\+.~#?&\\/\\/=]*))\"\\s*)*\\]",
                    "in": "payload"
                  }
                ],
                "decode param": "(?<=client_assertion=)([^&]+)",
                "from": "body",
                "type": "jwt"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "This test can be performed by taking the JWT present in the 'client_assertion' field of the RP's request, base64url decoding the payload and checking if the aud claim is present.",
        "name": "Does the signed JWT assertion contain the aud claim",
        "operations": [
          {
            "decode operations": [
              {
                "checks": [
                  {
                    "check": "$.aud",
                    "in": "payload",
                    "is present": "true"
                  }
                ],
                "decode param": "(?<=client_assertion=)([^&]+)",
                "from": "body",
                "type": "jwt"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "This test can be performed by taking the JWT present in the 'client_assertion' field of the RP's request, base64url decoding the payload and checking the exp claim. Its value must be a timestap",
        "name": "Does the signed JWT assertion contain a correct exp claim",
        "operations": [
          {
            "decode operations": [
              {
                "checks": [
                  {
                    "check regex": "\"exp\":\\d+",
                    "in": "payload"
                  }
                ],
                "decode param": "(?<=client_assertion=)([^&]+)",
                "from": "body",
                "type": "jwt"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "This test can be performed by taking the JWT present in the 'client_assertion' field of the RP's request, base64url decoding the payload and checking if the exp claim is present",
        "name": "Does the signed JWT assertion contain the exp claim",
        "operations": [
          {
            "decode operations": [
              {
                "checks": [
                  {
                    "check": "$.exp",
                    "in": "payload",
                    "is present": "true"
                  }
                ],
                "decode param": "(?<=client_assertion=)([^&]+)",
                "from": "body",
                "type": "jwt"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "This test can be performed by taking the JWT present in the 'client_assertion' field of the RP's request, base64url decoding the payload and checking the iat claim. Its value must be a timestap",
        "name": "Does the signed JWT assertion contain a correct iat claim",
        "operations": [
          {
            "decode operations": [
              {
                "checks": [
                  {
                    "check regex": "\"iat\":\\d+",
                    "in": "payload"
                  }
                ],
                "decode param": "(?<=client_assertion=)([^&]+)",
                "from": "body",
                "type": "jwt"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "This test can be performed by taking the JWT present in the 'client_assertion' field of the RP's request, base64url decoding the payload and checking if the iat claim is present.",
        "name": "Does the signed JWT assertion contain the iat claim",
        "operations": [
          {
            "decode operations": [
              {
                "checks": [
                  {
                    "check": "$.iat",
                    "in": "payload",
                    "is present": "true"
                  }
                ],
                "decode param": "(?<=client_assertion=)([^&]+)",
                "from": "body",
                "type": "jwt"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "This test can be performed by taking the JWT present in the 'client_assertion' field of the RP's request, base64url decoding the payload and checking if the iss claim is present.",
        "name": "Does the JWT payload contain 'iss' claim",
        "operations": [
          {
            "decode operations": [
              {
                "checks": [
                  {
                    "check": "$.iss",
                    "in": "payload",
                    "is present": "true"
                  }
                ],
                "decode param": "(?<=client_assertion=)([^&]+)",
                "from": "body",
                "type": "jwt"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "This test can be performed by taking the JWT present in the 'client_assertion' field of the RP's request, base64url decoding the payload and checking if the jti claim is present.",
        "name": "Does the signed JWT assertion contain the jti claim",
        "operations": [
          {
            "decode operations": [
              {
                "checks": [
                  {
                    "check": "$.jti",
                    "in": "payload",
                    "is present": "true"
                  }
                ],
                "decode param": "(?<=client_assertion=)([^&]+)",
                "from": "body",
                "type": "jwt"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "This test can be performed by taking the JWT present in the 'client_assertion' field of the RP's request, base64url decoding the payload and checking if the sub claim is present.",
        "name": "Does the signed JWT assertion contain the sub claim",
        "operations": [
          {
            "decode operations": [
              {
                "checks": [
                  {
                    "check": "$.sub",
                    "in": "payload",
                    "is present": "true"
                  }
                ],
                "decode param": "(?<=client_assertion=)([^&]+)",
                "from": "body",
                "type": "jwt"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The client_assertion parameter in the token request sent by the RP must be a JWT with a signature",
        "name": "Does the client_assertion in the token request have a correct signature",
        "operations": [
          {
            "decode operations": [
              {
                "decode param": "(?<=client_assertion=)([^&]+)",
                "from": "body",
                "jwt check sig": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCgOXFh2jO6E1hY\nOVwTbRiUPhjolp9tyi/beKK87KENOMqhFiw+P2EBhx9PC7aifwhM8iXMqKiMLgd/\n3mZxeRbRpLd/urVCToSKMy8x060Qceb4HqE+BFnD4ixAXGpclWXMQQ55u3qc/qma\nEA/YnsBT27nTt8xwcmb7AnCENzNtHt0wMTSBVLMmBc9iLMRwuIccXQorwuXTbbIV\ndmH4vdXn8JE9upENwWTO/rfSGmFifnxa5DXjt442CjeVecur2UA/WChmcEuJi8fh\neuGzGqF0KRitC6S0zaQfTKHsiDmoN0hl7uSLdg4Vm1NnyIexUOYM8nlEHcagf4Is\n+Ogu4uU9AgMBAAECggEAe+qxVBqsMtdPVjxWh/eyMMSuAwSrHQBobvcn9bGVBWLM\n5DT/1syxu7rDbiEDCT3yL4B/138BjBj1V+GrnUsnaNBZ0wGVukh7nV7ku0aY7MUK\n+w7Fae93dVXxH33aDOzGpGgUR/XFaLJUfYC6oLB20uR3HdVi2fzAxJUobDk9HsCs\nq4XrkD4bvlo5pEyGbxupuUKZDFcNq9H2kfo/Ah7hhAHr8ifQ6HlVQTGJwzWTe5gq\nep0Kdw+cyIvQgSoHTLHfFAkisWm3WGzSurHMnlbNx2uu05H1CPfOfEaMaGkCKuQc\n80mvOaq2vzKM7SPJkItM/gfIaHT8TIj5JxPRD2+yQQKBgQDQpmiHt5hLPeooZsVg\nIDv9X70+rUDikuVp206V3H78dR3eA6GZs4DTk0Npmgc9g5uA3g2W3Dtirj+EKtsb\nibazv0nHQjKFPhj6Atn0/Gj+3fwW/MNJMuKijRpN6DHb7L+jQBt/cLKAyPema3Lz\n6UCIkcsWTyyHhBp5iTl1lhFDeQKBgQDElbsacCDGB35FuRjuNejADroRLdZmWkMy\nVnSaevJfnGc91oyhz/Z0ZCIfed5bVOIK5gGtlbj7Nu/mJqJ72tp/IvNN0yzpWIyT\nv6KDmQI+ZlQBw1mjTbrYauMEwaab20FM4nn5hIk5bYXi0+ej3HwPAbDLNlT0JpnL\nhAjdLkFa5QKBgBVLtsWLXpbnZdvjyWdrQtQ0jls0UbgOaC3qvVWcYLWhun+rfTXz\n1UVC9ZF0sCJ+KUP45ggsyD7lLARwX1arMqOb9YrJ3eAtm10BJ3/St2C0BYPPHpt8\n/xa6MiIbfeNFgbXG2EekmAN+/4/TzbLJbtXBk6neQNxABne7Iss2muJ5AoGAFPYS\nOUNzeyoZYL3X1q6Q3smzNVm53rgJKjjlvgMWDPPUXleeLzLJiKeUq96Gwx5N6/OS\ngjvQuZimA9hiwuoXGi9T2hyGUWtLsgVhAr8x6g1nL7jwueTz41eiVUOAzGWYlOYh\nM2Xaa/EtsX3+2Q4NfFwlycVFUbM7+uNdPphMB7ECgYEAqpF6//mt0NfK1ROgBwkb\nLRBnQg00IM7mWExbQW8V0ET8DInpveSOg3oFaMoeIrd7sPEO2IKU2vrq1weMZBoL\n6+fmKc6AlgBsUUqSSUaot0hGAytkzHj30efJVghnHuzORgKzv9a3eXmyD4LUNrGH\noIQuP3rN+iRTRZ/gmHLRHyo=\n-----END PRIVATE KEY-----\n",
                "type": "jwt"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The client_assertion parameter in the token request sent by the RP must be a JWT",
        "name": "Does the client_assertion in the token request contain a JWT",
        "operations": [
          {
            "checks": [
              {
                "check regex": "client_assertion=([\\w=]+)\\.([\\w=]+)\\.([\\w\\-\\+\\/=]*)(?:&|$)",
                "in": "body",
                "is present": "true"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The token request sent by the RP must contain client_assertion parameter in the URL",
        "name": "Does the token request contain the client_assertion",
        "operations": [
          {
            "checks": [
              {
                "check": "client_assertion",
                "in": "body",
                "is present": "true"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The client_assertion_type parameter in the URL of the token request sent by the RP must be set to urn:ietf:params:oauth:client-assertion-type:jwtbearer",
        "name": "Does the client_assertion_type parameter in the token request contain the correct type",
        "operations": [
          {
            "checks": [
              {
                "check": "client_assertion_type",
                "in": "body",
                "is": "urn:ietf:params:oauth:client-assertion-type:jwt-bearer"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The token request sent by the RP must contain client_assertion_type parameter in the URL",
        "name": "Does the token request contain the client_assertion_type",
        "operations": [
          {
            "checks": [
              {
                "check": "client_assertion_type",
                "in": "body",
                "is present": "true"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The token request sent by the RP must contain client_id parameter in the URL",
        "name": "Does the token request contain the client_id",
        "operations": [
          {
            "checks": [
              {
                "check": "client_id",
                "in": "body",
                "is present": "true"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The token request sent by the RP must contain code parameter in the URL",
        "name": "Does the token request contain the code parameter",
        "operations": [
          {
            "checks": [
              {
                "check": "code",
                "in": "body",
                "is present": "true"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The token request sent by the RP must contain code_verifier parameter in the URL",
        "name": "Does the token request contain the code_verifier parameter",
        "operations": [
          {
            "checks": [
              {
                "check": "code_verifier",
                "in": "body",
                "is present": "true"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The grant_type parameter in the URL of the token request sent by the RP must be set to authorization_code or to refresh_token. So in this test a token request is taken and the grant_type parameter is checked",
        "name": "Does the token request contain a correct grant_type parameter",
        "operations": [
          {
            "checks": [
              {
                "check regex": "(?<=grant_type=)([^&]+)",
                "in": "body",
                "is in": [
                  "authorization_code",
                  "refresh_token"
                ]
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The token request sent by the RP must contain grant_type parameter in the URL",
        "name": "Does the token request contain the grant_type parameter",
        "operations": [
          {
            "checks": [
              {
                "check": "grant_type",
                "in": "body",
                "is present": "true"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The token request sent by the RP must be sent in HTTP POST",
        "name": "Does the token request use HTTP POST",
        "operations": [
          {
            "checks": [
              {
                "check regex": "POST",
                "in": "head",
                "is present": "true"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The client_id parameter in the URL of the token request is taken and checked to be an HTTPS URL",
        "name": "Does the client_id in the token request contain an HTTPS URL",
        "operations": [
          {
            "checks": [
              {
                "check regex": "client_id=https:\\/\\/((:)?www\\.)?([-a-zA-Z0-9@%._\\+~#=:]{2,256})(?:&|$)",
                "in": "body",
                "is present": "true"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    },
    {
      "test": {
        "description": "The client_id parameter in the URL of the token request is taken. This parameter must identify the RP",
        "name": "Does the client_id in the token request identifies the RP",
        "operations": [
          {
            "checks": [
              {
                "check": "client_id",
                "in": "body",
                "is": "X_https_RP"
              }
            ],
            "message type": "Token request"
          }
        ],
        "result": "correct flow s1",
        "sessions": [
          "s1"
        ],
        "type": "passive"
      }
    }
  ]
}